package io.github.unsignedint8.dwallet_core.u8

import io.github.unsignedint8.dwallet_core.bitcoin.application.wallet.Coins
import io.github.unsignedint8.dwallet_core.bitcoin.application.wallet.Wallet
import io.github.unsignedint8.dwallet_core.bitcoin.protocol.structures.Transaction
import io.github.unsignedint8.dwallet_core.crypto.Crypto
import io.github.unsignedint8.dwallet_core.extensions.hexToByteArray
import io.github.unsignedint8.dwallet_core.utils.BloomFilter
import org.junit.Test
import org.junit.Assert.*

/**
 * Created by unsignedint8 on 8/26/17.
 */

class WalletTests {

    private val wallet: Wallet
    private val filter: BloomFilter

    init {
        Crypto.setupCryptoProvider()

        Wallet.changeKeysAmount = 1
        Wallet.externalKeysAmount = 1
        wallet = Wallet.fromMnemonic("parade skill social future veteran cigar chef bleak federal benefit steel such car air embark music solid adult setup walk leader engage filter spider", coin = Coins.BitcoinTestnet)

        filter = BloomFilter.create(Wallet.changeKeysAmount + Wallet.externalKeysAmount, 0.001)

        (wallet.externalAddresses + wallet.changeAddresses).forEach {
            filter.insert(it.pubkey)
            filter.insert(it.pubkeyHash)
        }

        wallet.insertWIF("cQqABdMtNTk894GxuAJWJfF2S7Ln31LnzkUsvLiCznLaSEvkwR9y")//mwT5FhANpkurDKBVXVyAH1b6T3rz9T1owr

        println(wallet.externalAddresses.map { it.toString() })
        println(wallet.changeAddresses.map { it.toString() })
    }

    @Test
    fun testIsValid() {
        val tx = Transaction.fromBytes("020000000b03e61d3ff653fd1106344cc1eccba791ae4fbb60f97589e5af5a076aa751c60f0000000049483045022100d2cadff06ea897032ddc1b4688af5d7a2901ea1bc0399554cce592d56f22152a02203823944a3693998144d59ea691ec90425a3eaa133dbae9a00708039634a1dd6e01feffffff114c3eb41b17f4640d0894066b625df145e45159dfc98e293346349e83b0949b0000000049483045022100cfc8c7dcf9cf52922b15e73150016a0cf119152d2bbddad4c7ae5f85bfc1969d022044576f2a920b2baf0eaceadcafe4d3c6dac07c052a4e588978c3cac8fa91c94501feffffff693efd70ebe6fd087bd15f8f6411c275e815dbbf4dd32dab95a187a03ee4fb120000000049483045022100d0a74bd5169238f046476aeeb85c762035d2fb1cf04efecee57893a7d091405602204f99fd0dd64466cead82aa7495aa08160b93612dde8750950bef388455e13d5601feffffff79e077943f51a7785b637037a0b8af6dd24d6eb2df696c5c43e88f40cbc75b4f000000004847304402207688faed291e1009e280e457b9a8a255c878ad067c22cd4af2bf8fe6318afb68022026e68a2fa86ae6299dab7574fdd7ec9bbb78a6b6d3c873719a78738e9e7229b801feffffff7fbb91421f16c52584ceb2b0c4a3c79679fd36ea7c024149a66c56d8e3b6044a00000000484730440220256ac119b1ef6bbe2dab8065714b09cbbd816766995c2ff0b492c37fc53194ea02207f29fb3714083c7abea2916ad4410f2885be5d2f17fc7dc3443e561e3862219701feffffff952399c110cce5ec681c8cfeeaa6e5b7c12a5a7a85954050d915204118f32afd000000004847304402205061f93c6a05948c5ef341153e7dbaa7307f3322811cb0fae9dc8e982e8e82a402203533ac4e6beb1144222a79043ed2e9afffef336bae431c81f5ec35818d2c194b01feffffffd0a86b48dc199d2c43f5288cd8ec303bf5ed1ecd0fe9573bea7fe4b3f0c633c00000000048473044022034b7a2eeeef92775289b406ced0fc26d15758377b417eef65739af2273994c1b0220239b3db0d7b963dd5412ed0bb08eb7c025a6bb64ab83a1c58099e1d4aa120af701feffffff2a05e3197b56082e3ea102c91184511c3a8d4154d154b0c05b122d84f7dc6d98000000006a473044022041f9d1cd4b0e3a8b4678398ab169ded8e39600738e7dbcaeabdd5a17f4bf82af0220704a041b8fb899f6201b8b24c2fa49754d8ef563a35a3ea1277e0278b98a8a460121037363481179ae6496d8698fc6beb554b843ff5835f0e228a5b5288f688af2992cfeffffff67fb551aadd906cc72e00232f818697cd6ad9e6cd934024cb6831dff9bc53e84000000006b483045022100f82dd08bb48fe304c94313ae1e3b4de14d02f6ebc58e0172cde3e1bd33b5c6f6022045359ac6694e68b4a9e40a9b9a718fc5dc28e5b91789634b5371b96bd1c5b39b0121035dc39903575f472ba45b463ad687646fa8778d09047f3993c41d3a7adb120c6dfeffffffeac00ed589b956f33bd01c71baae2d66b2d13d7c5201f8ce3d231bb78d042d2f000000004948304502210090c1cd734480facc07caf9223417961db825f6fb53d17c6a8695210fe3c29af60220704303bdf0112d8328645474e5e6285eaecaccdcd2256711439c0804597fd91201feffffffc33ace425b352babe3b44abeab7115d8d405753d6d144c04ec1666b6dd2f2fe7000000006b483045022100b9faed87c7ae745b38fab421f6616079188803504ea07bb35a5645b906af1db102205aaf57bd96ee2f7f69da54bf6b57a7ce5c8e4712873d706aacbe73ce555c7dcb012102e97acf7ba8f336c3b08ff6aac79ff15b9dc331b4dc59d081bfc486278d41152efeffffff02b7d40e00000000001976a91402dbbfe0a50d9860ae5b82f2ec6c827c377340e288ac00e1f505000000001976a914ece7610011e33565e4c2c425ac902761853cbb5f88acf3090000".hexToByteArray())
        assertEquals(true, wallet.isIncomeTx(tx))
    }
}