package io.github.unsignedint8.dwallet_core

import io.github.unsignedint8.dwallet_core.bitcoin.protocol.structures.Transaction
import io.github.unsignedint8.dwallet_core.extensions.*
import org.junit.Test
import org.junit.Assert.*

/**
 * Created by unsignedint8 on 8/21/17.
 */

class TxTests {

    @Test
    fun testDeserialization() {
        val raw = "020000000c1ca6da37a1b952f300da58d27436951fdd21fb9c8939649fd0ea8310951dfcfa020000006a473044022034283d0b9b161f8ec747baeb7c5e0508fcb026441d223cffcdfe1f5eb106e3c00220661ebf44584d3f7c9fcb262d7fba39e285fb90949a97dac8ec6128c58a6a283901210262c73907f1933f280d96ababed53b97dc7bdd406d39108e62d6a9ec2d7d29a3cfeffffff1db453f3ce1f414c9f21e6c78b0bd7981985e9affc345042fc1058ec41b05359020000006a47304402201ba065c9200352725bb900ced07cb6a306bf899f92b8e02ed7f34c039d20cf45022074777a3612e566f578639c959fd6f3a4d5c3a745dd71d86bcb8afc68c4e0275901210262c73907f1933f280d96ababed53b97dc7bdd406d39108e62d6a9ec2d7d29a3cfeffffff26e5e287df7fc5654100621b4c267f3a79f707966e5c6156450627c5e03b3ab9010000006a473044022070efb13d83b0f5432b8d6c99b9ca0a802f4703bb9fe660175dffe0182ac7597a022073d12fd00a5e1cfbf3601d9c4a19a913e7a1e01ccbd0441f0b77b2a525c8720d0121028a3361822dd96f1e0831ac36abbeb10e74224729fb201fefde885d2463723487feffffff30677129a452e5678d0c37a2da3350f53430662f22ecd9303cb405b9f53e632c010000006b483045022100d81a8719711943d2ecb4802be4ff52607b3065487e687a102c2407d506ad0c7602207abe6fb4c43d2f62b37beed79e9a3aaeeb502f5e41922141f8d569221752b0dc0121028a3361822dd96f1e0831ac36abbeb10e74224729fb201fefde885d2463723487feffffff620ff329efa5bbebfbf6dfa30416d03f3d1e4836a3b28e929dfb38f6e1775bb4010000006a473044022025b2cd59325d5dba757d85be399cd9e0a49948e8edf972ee96bb8e67d8c1365702202c780a71debc2a4bef838ee9f2d9e85238b284850fb2d001d6bc74a290c8bd9e0121028a3361822dd96f1e0831ac36abbeb10e74224729fb201fefde885d2463723487feffffff8413f23237d97940047eaeb6808cc674389be4ef82861b84840d9a3d30b78c5a010000006b483045022100dcebd750369753babe5cbe38cae0057bee18838f7941a4e79db9f69f4a0e521702200d2f718307d97386cfcfe31861561d1916f78028529c4d7bde96a31c019c97010121028a3361822dd96f1e0831ac36abbeb10e74224729fb201fefde885d2463723487feffffff84fd198ba1042fc7cda946e8bba318ed29ffc88d03e2ce33cfa3a468efaffe3f020000006a473044022100fc8cd0ba2eaa190cf2e9a53c840212a8c34d5e68d0007625d4ac2e1220e1bffb021f17526b272b475d0c65fc9b62cbcfac3d4b62ec5e961862667f21af4811f2c201210262c73907f1933f280d96ababed53b97dc7bdd406d39108e62d6a9ec2d7d29a3cfeffffffaa4ced1dd329f2814720c2104d661f00b233f57e71a30573dbdf901034de6b3b010000006a473044022021f84047353c55af855c25d3d6279ae87b7b5821b596fc59859d8da9d77c65a302204ab0a7f693057ea2a04e8b00cabb5dab5ba2c6adabef432953afd1457c53216f01210262c73907f1933f280d96ababed53b97dc7bdd406d39108e62d6a9ec2d7d29a3cfeffffffbbcb75f605ba339ecac696334c13ed0ce69f299cb5b4536b42460c103560860f000000006b4830450221009589df0db1e4fa33d1838af7de2b9aa2e175dd1c87d011781a0290faceed0d3602207a268eb6aafbb12e9463a7ec71e885c0e26f9ff175029e4251752c96dbd5c7800121028a3361822dd96f1e0831ac36abbeb10e74224729fb201fefde885d2463723487feffffffc2ecc5894bb2f81890dee2bbcd6bddfa77a0e9e224e69b894f275779592fc3ae000000006a47304402205a82f9c3ca629bf7bdaa497618ffa8b9c51689168c2610af08f541f25a8febb302204c82fd0f7b4a4428db361fa41042fb3a7e168138960fc1d6ddb4647748c546bd0121028a3361822dd96f1e0831ac36abbeb10e74224729fb201fefde885d2463723487feffffffc7f9267ec13562a127d2d768a3279416af9766777a0cb652591c9cbcd8db1e3f010000006a47304402202afcd2376492e94fc6dbd025161e549e9965395cbc6f8001da26a421ec3c79f4022041e44e18769d9865ab88bc87206eb9f139c92937ee75d2ea6b87b2214b904db70121028a3361822dd96f1e0831ac36abbeb10e74224729fb201fefde885d2463723487feffffffd9da13216a851a0a28a8f5d6893daa29629586d2e2c938021bb77677e20355a3010000006b483045022100d3fc0019fb3ec0034907cf9293dba052ca0b111f7e19c9a9e13d262d696931de022012bf781b651ecc1855f5678a8979d107ccdac006c7bf58433792102153dc98b90121028a3361822dd96f1e0831ac36abbeb10e74224729fb201fefde885d2463723487feffffff02e3e40e00000000001976a91425f9d6d776a18e4a4888edad7117061bc2126e8788ac00e1f505000000001976a914aec6287421dd340e06a5d01e9dbc1e9d37741dae88acf2090000"
        val tx = Transaction.fromBytes(raw.hexToByteArray())

        assertEquals(12, tx.txIns.size)
        assertEquals(2, tx.txOuts.size)
        assertEquals(2546, tx.lockTime)

        assertEquals("fafc1d951083ead09f6439899cfb21dd1f953674d258da00f352b9a137daa61c", tx.txIns.first().txId)
        assertEquals(2, tx.txIns.first().vout)
        assertEquals("473044022034283d0b9b161f8ec747baeb7c5e0508fcb026441d223cffcdfe1f5eb106e3c00220661ebf44584d3f7c9fcb262d7fba39e285fb90949a97dac8ec6128c58a6a283901210262c73907f1933f280d96ababed53b97dc7bdd406d39108e62d6a9ec2d7d29a3c", tx.txIns.first().signatureScript.toHexString())
        assertEquals(4294967294.toInt(), tx.txIns.first().sequence)

        assertEquals("a35503e27776b71b0238c9e2d286956229aa3d89d6f5a8280a1a856a2113dad9", tx.txIns.last().txId)
        assertEquals(1, tx.txIns.last().vout)
        assertEquals("483045022100d3fc0019fb3ec0034907cf9293dba052ca0b111f7e19c9a9e13d262d696931de022012bf781b651ecc1855f5678a8979d107ccdac006c7bf58433792102153dc98b90121028a3361822dd96f1e0831ac36abbeb10e74224729fb201fefde885d2463723487", tx.txIns.last().signatureScript.toHexString())
        assertEquals(4294967294.toInt(), tx.txIns.last().sequence)

        assertEquals(976099.toLong(), tx.txOuts.first().value)
        assertEquals("76a91425f9d6d776a18e4a4888edad7117061bc2126e8788ac", tx.txOuts.first().pubkeyScript.toHexString())

        assertEquals(100000000.toLong(), tx.txOuts.last().value)
        assertEquals("76a914aec6287421dd340e06a5d01e9dbc1e9d37741dae88ac", tx.txOuts.last().pubkeyScript.toHexString())

        println(tx)
    }

    @Test
    fun testTxid() {
        val raw = "02000000010000000000000000000000000000000000000000000000000000000000000000ffffffff0401180101ffffffff0200f2052a01000000232102cd7ea2fa4ddd1a2e5165457b99fb2df9d74953e6d383a7cde8d8cc73d47ea686ac0000000000000000266a24aa21a9ede2f61c3f71d1defd3fa999dfa36953755c690689799962b48bebd836974e8cf900000000"
        val tx = Transaction.fromBytes(raw.hexToByteArray())

        assertEquals("4000c7464f515006e6092fa8ca03d142118c2a924a0e6d4934a7eb1c84d6b938", tx.id)
    }

}