package dWallet.u8

import dWallet.core.bitcoin.protocol.structures.MerkleBlock
import dWallet.core.bitcoin.protocol.structures.Transaction
import dWallet.core.extensions.*
import org.junit.Test
import org.junit.Assert.*

/**
 * Created by unsignedint8 on 8/21/17.
 */

class TxTests {

    @Test
    fun testDeserialization() {
        val raw = "020000000c1ca6da37a1b952f300da58d27436951fdd21fb9c8939649fd0ea8310951dfcfa020000006a473044022034283d0b9b161f8ec747baeb7c5e0508fcb026441d223cffcdfe1f5eb106e3c00220661ebf44584d3f7c9fcb262d7fba39e285fb90949a97dac8ec6128c58a6a283901210262c73907f1933f280d96ababed53b97dc7bdd406d39108e62d6a9ec2d7d29a3cfeffffff1db453f3ce1f414c9f21e6c78b0bd7981985e9affc345042fc1058ec41b05359020000006a47304402201ba065c9200352725bb900ced07cb6a306bf899f92b8e02ed7f34c039d20cf45022074777a3612e566f578639c959fd6f3a4d5c3a745dd71d86bcb8afc68c4e0275901210262c73907f1933f280d96ababed53b97dc7bdd406d39108e62d6a9ec2d7d29a3cfeffffff26e5e287df7fc5654100621b4c267f3a79f707966e5c6156450627c5e03b3ab9010000006a473044022070efb13d83b0f5432b8d6c99b9ca0a802f4703bb9fe660175dffe0182ac7597a022073d12fd00a5e1cfbf3601d9c4a19a913e7a1e01ccbd0441f0b77b2a525c8720d0121028a3361822dd96f1e0831ac36abbeb10e74224729fb201fefde885d2463723487feffffff30677129a452e5678d0c37a2da3350f53430662f22ecd9303cb405b9f53e632c010000006b483045022100d81a8719711943d2ecb4802be4ff52607b3065487e687a102c2407d506ad0c7602207abe6fb4c43d2f62b37beed79e9a3aaeeb502f5e41922141f8d569221752b0dc0121028a3361822dd96f1e0831ac36abbeb10e74224729fb201fefde885d2463723487feffffff620ff329efa5bbebfbf6dfa30416d03f3d1e4836a3b28e929dfb38f6e1775bb4010000006a473044022025b2cd59325d5dba757d85be399cd9e0a49948e8edf972ee96bb8e67d8c1365702202c780a71debc2a4bef838ee9f2d9e85238b284850fb2d001d6bc74a290c8bd9e0121028a3361822dd96f1e0831ac36abbeb10e74224729fb201fefde885d2463723487feffffff8413f23237d97940047eaeb6808cc674389be4ef82861b84840d9a3d30b78c5a010000006b483045022100dcebd750369753babe5cbe38cae0057bee18838f7941a4e79db9f69f4a0e521702200d2f718307d97386cfcfe31861561d1916f78028529c4d7bde96a31c019c97010121028a3361822dd96f1e0831ac36abbeb10e74224729fb201fefde885d2463723487feffffff84fd198ba1042fc7cda946e8bba318ed29ffc88d03e2ce33cfa3a468efaffe3f020000006a473044022100fc8cd0ba2eaa190cf2e9a53c840212a8c34d5e68d0007625d4ac2e1220e1bffb021f17526b272b475d0c65fc9b62cbcfac3d4b62ec5e961862667f21af4811f2c201210262c73907f1933f280d96ababed53b97dc7bdd406d39108e62d6a9ec2d7d29a3cfeffffffaa4ced1dd329f2814720c2104d661f00b233f57e71a30573dbdf901034de6b3b010000006a473044022021f84047353c55af855c25d3d6279ae87b7b5821b596fc59859d8da9d77c65a302204ab0a7f693057ea2a04e8b00cabb5dab5ba2c6adabef432953afd1457c53216f01210262c73907f1933f280d96ababed53b97dc7bdd406d39108e62d6a9ec2d7d29a3cfeffffffbbcb75f605ba339ecac696334c13ed0ce69f299cb5b4536b42460c103560860f000000006b4830450221009589df0db1e4fa33d1838af7de2b9aa2e175dd1c87d011781a0290faceed0d3602207a268eb6aafbb12e9463a7ec71e885c0e26f9ff175029e4251752c96dbd5c7800121028a3361822dd96f1e0831ac36abbeb10e74224729fb201fefde885d2463723487feffffffc2ecc5894bb2f81890dee2bbcd6bddfa77a0e9e224e69b894f275779592fc3ae000000006a47304402205a82f9c3ca629bf7bdaa497618ffa8b9c51689168c2610af08f541f25a8febb302204c82fd0f7b4a4428db361fa41042fb3a7e168138960fc1d6ddb4647748c546bd0121028a3361822dd96f1e0831ac36abbeb10e74224729fb201fefde885d2463723487feffffffc7f9267ec13562a127d2d768a3279416af9766777a0cb652591c9cbcd8db1e3f010000006a47304402202afcd2376492e94fc6dbd025161e549e9965395cbc6f8001da26a421ec3c79f4022041e44e18769d9865ab88bc87206eb9f139c92937ee75d2ea6b87b2214b904db70121028a3361822dd96f1e0831ac36abbeb10e74224729fb201fefde885d2463723487feffffffd9da13216a851a0a28a8f5d6893daa29629586d2e2c938021bb77677e20355a3010000006b483045022100d3fc0019fb3ec0034907cf9293dba052ca0b111f7e19c9a9e13d262d696931de022012bf781b651ecc1855f5678a8979d107ccdac006c7bf58433792102153dc98b90121028a3361822dd96f1e0831ac36abbeb10e74224729fb201fefde885d2463723487feffffff02e3e40e00000000001976a91425f9d6d776a18e4a4888edad7117061bc2126e8788ac00e1f505000000001976a914aec6287421dd340e06a5d01e9dbc1e9d37741dae88acf2090000"
        val tx = Transaction.fromBytes(raw.hexToByteArray())

        assertEquals(12, tx.txIns.size)
        assertEquals(2, tx.txOuts.size)
        assertEquals(2546, tx.lockTime)

        assertEquals("fafc1d951083ead09f6439899cfb21dd1f953674d258da00f352b9a137daa61c", tx.txIns.first().txId)
        assertEquals(2, tx.txIns.first().vout)
        assertEquals("473044022034283d0b9b161f8ec747baeb7c5e0508fcb026441d223cffcdfe1f5eb106e3c00220661ebf44584d3f7c9fcb262d7fba39e285fb90949a97dac8ec6128c58a6a283901210262c73907f1933f280d96ababed53b97dc7bdd406d39108e62d6a9ec2d7d29a3c", tx.txIns.first().signatureScript.toHexString())
        assertEquals(4294967294.toInt(), tx.txIns.first().sequence)

        assertEquals("a35503e27776b71b0238c9e2d286956229aa3d89d6f5a8280a1a856a2113dad9", tx.txIns.last().txId)
        assertEquals(1, tx.txIns.last().vout)
        assertEquals("483045022100d3fc0019fb3ec0034907cf9293dba052ca0b111f7e19c9a9e13d262d696931de022012bf781b651ecc1855f5678a8979d107ccdac006c7bf58433792102153dc98b90121028a3361822dd96f1e0831ac36abbeb10e74224729fb201fefde885d2463723487", tx.txIns.last().signatureScript.toHexString())
        assertEquals(4294967294.toInt(), tx.txIns.last().sequence)

        assertEquals(976099.toLong(), tx.txOuts.first().value)
        assertEquals("76a91425f9d6d776a18e4a4888edad7117061bc2126e8788ac", tx.txOuts.first().pubkeyScript.toHexString())

        assertEquals(100000000.toLong(), tx.txOuts.last().value)
        assertEquals("76a914aec6287421dd340e06a5d01e9dbc1e9d37741dae88ac", tx.txOuts.last().pubkeyScript.toHexString())

        println(tx)
    }

    @Test
    fun testTxid() {
        val block = "000000207f026bea3f187657d0da0165b5122484cb91b292f00cf76323617bc841c8f26997e9e1dc840597b09b0718c1e116e5073f2c3c0b3120e5d8c4585918942d481c35209959ffff7f20020000001500000009e998e96c234906c36554da9a65c89d3ad2f7465011bb5c0861bd4baf401b15aa8c0e129c7a25c70fe3743ca211360b78a014ce586c111e0bf3d2d1ee2bb2d76f1fdbcdfd973af046ef7284b447538c82c85e4fdd55fa30388a20cb5d07869182bcdc2b00cde50206eba96a2e3b2879595e9c860aaf2e0393126af3618ff26f117cbf05837978e77a66e816f166853ff52d1ecf1be97eecd21646d278a75bbf85d0604b75b6535ad9db1da5441d62e85e64bc4a0daef663d62bcb37e9a7676c225b8a2b900f84ec0ab057b3aaf64ceb8149e8b0baa9fe19758135543b15cf7d2a7e0aab356100427949127dfe3e568297d26ac94eec67a81eb85a139a543132cb9511c21ab4af50fd2938a7722ae2906452869e3a623063534e8c0f905f0cf848035f5a00"
        val mb = MerkleBlock.fromBytes(block.hexToByteArray())
        assertEquals("69f2c841c87b612363f70cf092b291cb842412b56501dad05776183fea6b027f", mb.preBlockHash)
        assertEquals("5cac92233808ec7e64004eb32f14da3964549c2ea3828ce2e971cf4749e8fea1", mb.hash)

        var raw = "02000000010000000000000000000000000000000000000000000000000000000000000000ffffffff0401180101ffffffff0200f2052a01000000232102cd7ea2fa4ddd1a2e5165457b99fb2df9d74953e6d383a7cde8d8cc73d47ea686ac0000000000000000266a24aa21a9ede2f61c3f71d1defd3fa999dfa36953755c690689799962b48bebd836974e8cf900000000"
        var tx = Transaction.fromBytes(raw.hexToByteArray())

        assertEquals("4000c7464f515006e6092fa8ca03d142118c2a924a0e6d4934a7eb1c84d6b938", tx.id)

        raw = "020000001201dce8936e8a07b8352063ce3947c9aec0786bf09498012cd331960d8bbb69780000000049483045022100f09615985a0602e15661d82c1716740e2b5a7e6d43e699af5b7ef0da5a89617402206240af1e64f88de41fe774e3377e7e75bd5761369c89829042d3696b306d00b201feffffff1525f06e85d1caab916a0e499e7c2836f1b0d75340e9b20a988da3ed67ec80c10000000048473044022038fd176c508d5bd7010a49b54a7fbb264c8cbe15006b8e1830f8cbcaf478cb8602206fbe7877b87f95b7df27d48e328fcfcbaf1cdde66d1b9aea0fde2109d1800e6d01feffffff32a945b29804ff6c7d00e23763802ed448dc5bd14c6a437c714ef7c517683bb400000000484730440220321eb5a21c870c51cfe81d8378f9ca935bf8fa343902243392d3bd2e3c4c5f910220296b9fdab364e41c215a4bfb4f49279e2ef3fa6d2a424b37b06f26485b26207401feffffff3a538ca976766f432541a0769fa15b90f95ccb438f660bf3e5a2be9300500d0c00000000484730440220229cae60eed8616752c690198eead1241b4365bd6cb292605b2fa7db0cb353bd02201d3772d977a6d74788e3ae645e4eda1d22d238240dda0f8e9f7683a9509033f901feffffff40596b273a00ee7aad7ef286fcb834eb4eb37a50a2052282357f2e417921eca1000000004847304402205e3bfa92bfeeb14426e1bc577f72f657b5ca026814d779c4b327607bef91932902202bc7c0f5eb67e3ad5b19ad8dc6f9bbba54a9b8cfa0b914a5646610a6bda3136d01feffffff5271394b5c36ab9832efaddb6a80295c3a188d277285aecf733ce6620bb70ecb000000004847304402204bfb0935a7ae021ce60e594290165e4a05c796804ca7f146963b038202473506022079ce0272b13c9155c45be4dc4461671a64a07934c35d078b66f65257341abd5c01feffffff54986ca6373271dccef554da49ebf0803400f3212a38f340311717fd7faee576000000004847304402204e1950f6edc1c75a73b59ec41b236b2bd9937297c499f8f3f68abb616536d4090220561282d52f30087f2864f94ccf5ddd611949986064903d34bd94954ca86260b001feffffff5d21b863d1b6449022e2f49af445854851d0251c1174959c8df9bec677b2f7d5000000004847304402206a42646c2a08221cc40a19aaf0e4d528f97f871450fbe9314fdde258e5b93ae702202bd569bef1c0c44147a705bf88d7451f79bd05cfa753d5e6cca78ae40414f68801feffffff7aa380952ddd25241f92ffc28a5a861a3bbc926d76a19d10e8263910f2aead070000000048473044022065d66cc7cc07c838c0330f816356a34f062080aac900e3224da0271062aa39a6022003f3ffb22d9801f5ef2fd0eb094e8adf609ffe6c644fb0ec6887aa13629939aa01feffffff7eccb820b3c8cdacb934e090e04c5edb4ef2db0aeb8d98f56631716743b21e940000000048473044022045c573d0dc81c389f824555ff6d916d8893c80d28039664d9b1cdb30b5960c580220641a90dbd6642733738c61e3b97df27b1f51a2044e9ed61a3c9c58f2e139b37c01feffffff805572d7c7abbe9ac4b42c256975594c443cba3a731956f13715a9c8843b1388000000004847304402205268aff626ed80ee27e276a569423a9a164b0daa958a6a85b2151938c660e17902201276f618097590d479dff8375ae78be48c7a7da11a8688981e9b4cef41ece76b01feffffff9a9e579ae27fe8764aaaf2533bed90ccb08cc5e097d7715263fbedaf9d79f2440000000049483045022100b7a5c16daf7c3b54ebcd989cbb1ee44cd8412806ecc50e9537688c6d8bc75900022024f1d0082605616845cde0746a0a3ceab381f1d96551bad063dccf7a84f6c2d501feffffffabfde531588c671eb6c3fcbf342fbeae78cd1eb8ce623bb53a77b8bfd8ae04ff000000004847304402201c81065aa356bf345b871146419fce589b1cb8ae4b5e8e474ee854c6117714f8022032dbfa3a3d604375f48010012913567f3afc8df2d3078f165cb936ac8fc9c53101feffffffafe1dc3cad642c86ab9196914c2d3b9ecbfebc45be5ad44c0b40c2aa7239c87e000000004847304402201d45cfc6bf68307d874f221871c4911348b4a0c1f41365a1cc3f73add35cc87e02200e326c52d171d7688363a0b63e3f38d9b91111651674de1b3daf910ae69c949101feffffffc5109328ce0fd3f6e6bcae894de588134dc2a77bb7d6929e6fa82f74d8f222fe000000004948304502210096b715521b8d903590dcc0c3627a7b5dbfde6d076bd6ad8b192e1829fb3494ac02202e3c848f8102930e132e368b1d284797f65a948b5f47a337d66a396d5d97ae6501feffffffcf04cb91a41c12eb3248dd69ee577b781705d57001c0aec2516c3148960b0372000000004847304402207f9bd2c536dc83f852fb6dddb9ee65d55eabef2f2c73317cb7062ed9d77f283a02201564a954443a3c87790b75409a73fea559fcef5ebd277491722160f9f09d2a3d01feffffffe974417fdca5bd12383170acd097d519ad7ebc43c09de93c4b32b6beeb1a95810000000049483045022100f76283cd1123435e46557e5dde53d1771e7fb6ad8b4472721ffef577aa9ddbb902202cc499b9bdb1c6f2961c90b20b9c0f22dbed9ec1d5e35dc199a83836826e4cb801fefffffff0646f8ec827c23f9703db1daae6ba17aef7580ee66cb668210f2dc90f61af1600000000494830450221009a70fa6ac0392246cb870dfd4d2fd3d5fa051029f79fcd53c74dbc509b5f019202206da4076a4e747c22e2bc4490baac94ae83cfec5685db6fe6559a8fb391c49fb401feffffff0200e1f505000000001976a914955fdc03645db4fc7d60146416e6db31386c392d88ac4dcf0e00000000001976a9145fa4ebbd7f72dd17fe0f3a5896192e0d58ae74b788acf2090000"
        val tx1 = Transaction.fromBytes(raw.hexToByteArray())

        assertEquals("6fd7b22beed1d2f30b1e116c58ce14a0780b3611a23c74e30fc7257a9c120e8c", tx1.id)

        raw = "020000001204667f1f1caea1392c1d422c907968973c7b291cc586c5c76e94ce559419cc2d0000000049483045022100edd91ff533d180edfef262413b2a6fb27968fb433b5e7f8aa38f817381375c45022026e0312b97653e13068d7cbb3af6d444b49dcf0ff8797a96f04c31ddcc70653c01feffffff1203ba87bdb998fd337bb63690a154b4884e8aad5321d9d20104ba9c37109e9500000000494830450221009d6cacd83809afd79d305cbecfbb66546dd1398087260802c1c64937a7b9a4d002204917678a61ca038851dbdd8829e1b1323e8f21b20eb66dea021294dc181e15f301feffffff245cb1f0dfd56b1905c21094fc01ea52d3dd19e5536bf0106392e9c1216cc1d5000000004847304402203b729c73ff0742ad2cd99bb74c6da2aa3837f1b9e109bea18c87255b5fafaa5402204c874db6903720c9481479d030f863c574be3d99f820c946a16b4e931ff21f7901feffffff3325b19b71304a287125f51424922b3317dac167e7ae25bf3d7e6058831fc7f70000000049483045022100ffe6dce605f4c23b9172203aced5bd0bf8b8e836e482a59389f361f27a6637780220458afb95e579838db334abccbbd55464d5a27c86b43ffbf2ff2e1b07529806f401feffffff35f7c5cc6d42d7f5ef94510f2a2285fc989236581f516ce9ff15fbbe9dc4b39a000000004847304402205b831b6b8cba78ba1d788010ea01927f67cd8f02dee5ce928d500795e536b9270220568c786c772fdfddb306539834b4b3d800390dc63f97ffcfddb4fe8cae2bd5d301feffffff42aaed41b02cb7f35b86590c6a2e5b716ee5c65cb6a2b2228e13867e0de5ce320000000049483045022100bfe9e9a27a48d01914670ab55e4eb7464acf7c2626ef7ca2e5fc5fbcac9c5fd10220161383e76ba5ad012532d6aad04bba33a5db53c95df6341943e83c3e29a982fd01feffffff445e2dc59f4afbcc64049a76471a934bb03d76cc8c39a204d75c2ccefa1c4caa000000004847304402205963376d2dd6d9768ffe6b303b92fc152b99fc22ef5f52251e75f6623f8e0b7202201ee5d9034d17f2e0cb09c179fbd8dd1ca49d0f1328a7427e71e118aee09bf19c01feffffff4a9822036b2a403f5e873b75a04ba86b69c081828f89d1e04188b60b1057bece0000000049483045022100e8e81955c16c2679bf06fc497f308b733cf45185c1d2c610b71c6c1f7c076af602204bf002a4cef8317f137252f5a66350b93912f66275c8df003ead1aea8a0c412a01feffffff588dc320756c8e33798189c6d295c78cdd21ba90b219f4699e7544f0d054150c0000000048473044022064073b90c09b573c536f359c3f445f629730b8a7981c62cf96ec0dc6dbf9f64e022066f9016aaa7cb3fa14c650678a25b1969d7de57b00c8a59980b75746b047ddb701feffffff678b4209c33d7d5eeac263b2b7b9616b41156d88444efc741a00e0cbd851d2c50000000048473044022024ba4ef890f3a3a7059267c5447c46d1c853cccc44f9202c3fd2e5e74a35aae70220668b5bb60956f9c1571b38e1ead64ccb05f3a3f33aac5792a3144fbea8c929c801feffffff7a8a8879b4f198387a3419bdb64f2aa543dc35e452b2f336809937e0266a7ebb0000000048473044022031c56f11fe96c4f05e4b5896b927eb0bef55202a980f374d034aecae2baae86b02203ec12164eb9bb1a8af522a3f19984481e7f0705ffe38ee4c5a968706304a1edb01feffffff7f76c7b6aa75dee3ea827f9e2526ee8ecfbd94b58ae668edb8d24931a9b99a9700000000494830450221009ce4f6f9411ca1248a1111412662929fbb5e9aa9abbfa46295b5a69009eea7a8022065964a1e79303c65fb5ea2955b3309b7c3a044546783bbe8292ed28cce96ca3801feffffffa6c524780f22fb424e33852b9c84ff277026c3b977300fda7633f0dce28fe6260000000049483045022100e9a57fb672bea4e61f63cc5f50fbf437b5927937cbddbff62d547f36b99ba49802201bff5b7ac01915aba077fea559b3fe2b73e7dd576631de68d98aa1e9819d4af501feffffffb40966f5799fd5b96294eea9fc11856a6406ff80a276fe4bae5138743c52498a000000004746304302207029cdcc7bd27d75300b1a43358b8d62542ab35a5373fdc77f1f7227aeee4900021f73141d50f062601f7e510f83d9835b059525840e9f6d20318ce8ba9d897bf201feffffffbb2998d56f19359d59f02013d046609271650746b3e6ec2b96252c9c41dd53400000000049483045022100e60f21da8c8fb8902bd737beb1b1691f4166720a20db24f17528af66372d3c3b022022f4cf05cd1d3b6fa1087d55f10eb8fc493555834475f20f31da1baf11fab40801feffffffc16e80b87a0a4cead982dbea327bde82df885f75a1dbd8d78c58ceaebb669f3a0000000049483045022100905cb829582a2e658189c97099e1d244e30312ea4cf2f4002ddf53639e8793e802204e0b76982c78066e1e5f6afca2e30941f81eb8d439261bf064b290e441b22ff501feffffffcbbba2dd85305528df501375d3c065ca9cfa7c4d902a94c6dcc403a175b0ee930000000048473044022054cbcea9b4b5da9b0d9e5b29be815d8609a76dd2e0e5aec5ec824b735bdbc45d022077d722d1f1e9a7aa260f271a1ca915c6a1565b064681b123b7ce8aab9f8ac12601feffffffda18690b0c5e760ab194e79ac94e62e495abbac85b720ae10d63651e5a579a5d0000000049483045022100c49836ef5e9e18445766f4875277ebd6cac9a638fd0090530cef105623996ce802202541b95c6997a0a7c2cd0c85f2b3fe313e463eaf67ad6e95c023f7222033996e01feffffff024dcf0e00000000001976a9148aecad473b46c32048fbcdc01ec2dae41a1a477588ac00e1f505000000001976a914955fdc03645db4fc7d60146416e6db31386c392d88acf2090000"
        val tx2 = Transaction.fromBytes(raw.hexToByteArray())

        assertEquals("2a7dcf153b5435817519fea9bab0e84981eb4cf6aab357b00aec840f902b8a5b", tx2.id)
        assertEquals(true, mb.hashes.containsAll(listOf(tx1.id, tx2.id)))


    }

}